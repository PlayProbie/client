var e={d:(t,i)=>{for(var n in i)e.o(i,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{Zb:()=>ce,xv:()=>fe,He:()=>o});const i="1.1.0";let n="none";function o(e){n=e}function s(e){"debug"===n&&console.debug("[Streaming Debug]: "+e)}let r=function(e){return e.H264_CONSTRAINED_3_1="h264.constrained.31",e.H264_CONSTRAINED="h264.constrained",e.H264_BASELINE="h264.baseline",e.H264_MAIN_3_1="h264.main.31",e.H264_MAIN="h264.main",e.H264_HIGH="h264.high",e}({});var a=function(e){return e.CONSTRAINED_3_1="42e01f",e.CONSTRAINED_4_2="42e02a",e.BASELINE_4_2="42002a",e.MAIN_3_1="4d001f",e.MAIN_4_2="4d002a",e.HIGH_4_2="64002a",e}(a||{});function c(e){switch(e){case r.H264_CONSTRAINED_3_1:return a.CONSTRAINED_3_1;case r.H264_CONSTRAINED:return a.CONSTRAINED_4_2;case r.H264_BASELINE:return a.BASELINE_4_2;case r.H264_MAIN_3_1:return a.MAIN_3_1;case r.H264_MAIN:return a.MAIN_4_2;case r.H264_HIGH:return a.HIGH_4_2;default:return""}}function h(e,t){if(t>0&&t<e.length){const i=e[t][0].match(/^m=(audio|video)\s/);if(i)return"audio"===i[1]?"audio":"video"}return""}function d(e,t){if(t>0&&t<e.length){const i=e[t][0].match(/^m=(\S+\s+){3}([\d\s]+)$/);if(i)return i[2].split(/\s+/).map((e=>parseInt(e,10)))}return[]}function l(e,t,i){if(t>0&&t<e.length)for(const n of e[t]){const e=n.match(/^a=rtpmap:(\d+)\s+(\w+)/);if(e&&parseInt(e[1],10)===i)return e[2].toLowerCase()}return""}function u(e,t,i,n){if(t>0&&t<e.length)for(let o=0;o<e[t].length;++o){const s=e[t][o].match(/^a=fmtp:(\d+)\s+(.*?)$/);if(s&&parseInt(s[1],10)===i){const e=s[2].trim().split(/\s*;\s*/),t=n+"=";for(const i of e)if(i.startsWith(t))return i.substring(t.length)}}}function p(e,t,i,n,o){if(t>0&&t<e.length){let s=!1;for(let r=0;r<e[t].length;++r){const a=e[t][r].match(/^a=fmtp:(\d+)\s+(.*?)$/);if(a&&parseInt(a[1],10)===i){s=!0;const c=a[2].trim().split(/\s*;\s*/);e[t][r]=`a=fmtp:${i} `+[...c.filter((e=>e!==n&&!e.startsWith(n+"="))),`${n}=${o}`].join(";")}}s||e[t].push(`a=fmtp:${i} ${n}=${o}`)}}function f(e,t,i){const n=`${i}`;if(t>0&&t<e.length){const i=e[t][0].match(/^(m=(\S+\s+){3})([\d\s]+)$/);i&&(e[t][0]=i[1]+i[3].split(/\s+/).filter((e=>e!==n)).join(" "),e[t]=e[t].filter((e=>{const t=e.match(/^a=[-a-zA-Z0-9]+:(\d+)\b/);return!t||t[1]!==n})))}}function m(e,t){const i=c(t);return i?e.replace(/\bprofile-level-id=[0-9a-fA-F]{6}\b/,"profile-level-id="+i):e}function v(e,t,i){const n=function(e){const t=[[]];for(const i of e.split(/[\r\n]+/))i.startsWith("m=")?t.push([i]):t[t.length-1].push(i);return t}(e);s(`parsed offer SDP: found ${n.length} media sections`);let o=!1;for(let e=1;e<n.length;++e){const t=d(n,e);switch(h(n,e)){case"audio":s(`parsing audio media section ${e} - formats ${t.join(",")}`);for(const i of t)"opus"===l(n,e,i)&&(p(n,e,i,"stereo","1"),s(`modified opus format ${i} in section ${e} for stereo=1`));break;case"video":s(`parsing video media section ${e} - formats ${t.join(",")}`);for(const i of t)"h264"===l(n,e,i)&&(o=!0,p(n,e,i,"x-google-max-bitrate","19000"),p(n,e,i,"x-google-start-bitrate","10000"),s(`modified h264 format ${i} in section ${e} for bitrate`),n[e]=n[e].filter((e=>!e.startsWith("b="))),n[e].push("b=TIAS:19000000"),n[e].push("b=AS:19000"))}}if(!o)throw new Error("Browser does not support H.264 video playback over WebRTC");const r=c(t);if(r)for(let e=1;e<n.length;++e){if("video"!==h(n,e))continue;let t,o;const c=d(n,e);for(const i of c)"h264"===l(n,e,i)&&("1"===u(n,e,i,"packetization-mode")?null!=t||(t=i):null!=o||(o=i));const m=null!=t?t:o;if(void 0!==m){p(n,e,m,"profile-level-id",i?a.CONSTRAINED_3_1:r),p(n,e,m,"x-profile-level-id-override",r);for(const t of c)m!==t&&(s(`deleting format ${t} in section ${e} due to override`),f(n,e,t))}}return n.reduce(((e,t)=>e.concat(t)),[]).join("\n")}function w(e,t,i){g(e,t),t.set(e,i)}function g(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function E(e,t){return e.get(S(e,t))}function C(e,t,i){return e.set(S(e,t),i),i}function S(e,t,i){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:i;throw new TypeError("Private element is not present on this object")}var b=new WeakMap,y=new WeakMap,M=new WeakMap,I=new WeakMap,k=new WeakMap,A=new WeakMap,_=new WeakMap,T=new WeakMap,R=new WeakMap,W=new WeakMap,N=new WeakMap,D=new WeakMap,O=new WeakMap,G=new WeakMap,$=new WeakSet;class H{constructor(e){var t;function i(e){return"errorDetail"in e?String(e.errorDetail):"error"in e&&"object"==typeof e.error&&e.error&&"errorDetail"in e.error?String(e.error.errorDetail):"message"in e?String(e.message):"(unknown)"}g(this,t=$),t.add(this),w(this,b,void 0),w(this,y,void 0),w(this,M,void 0),w(this,I,void 0),w(this,k,void 0),w(this,A,void 0),w(this,_,void 0),w(this,T,void 0),w(this,R,void 0),w(this,W,void 0),w(this,N,void 0),w(this,D,void 0),w(this,O,void 0),w(this,G,void 0),this.videoElement=e.videoElement,this.audioElement=e.audioElement,this.clientConnection=e.clientConnection,C(b,this,e.forcedCodec),C(y,this,new RTCPeerConnection({iceServers:[]})),C(k,this,!1),C(A,this,!1),E(y,this).ontrack=e=>{"video"===e.track.kind?(C(N,this,e.track),this.videoElement.srcObject!==e.streams[0]&&(this.videoElement.srcObject=e.streams[0],this.videoElement.autoplay&&this.videoElement.play())):"audio"===e.track.kind&&(C(D,this,e.track),this.audioElement.srcObject!==e.streams[0]&&(this.audioElement.srcObject=e.streams[0],this.audioElement.autoplay&&!this.audioElement.muted&&this.audioElement.play()))},S($,this,j).call(this),S($,this,L).call(this),S($,this,P).call(this),C(M,this,E(y,this).createDataChannel("inputChannel",{ordered:!1,maxRetransmits:0})),E(M,this).binaryType="arraybuffer",E(M,this).addEventListener("open",(()=>{s("Input data channel is now open")})),E(M,this).addEventListener("error",(e=>{s(`Input Data Channel Error details: ${i(e)}`),this.clientConnection.channelError(e)})),C(I,this,E(y,this).createDataChannel("clientMessageChannel",{ordered:!0})),E(I,this).binaryType="arraybuffer",E(I,this).addEventListener("open",(()=>{s("Client message channel is now open")})),E(I,this).addEventListener("error",(e=>{s(`Client Message Data Channel Error details: ${i(e)}`),this.clientConnection.channelError(e)}))}getVideoStats(){return E(_,this)?E(_,this):E(y,this).getStats(E(N,this))}getAudioStats(){return E(T,this)?E(T,this):E(y,this).getStats(E(D,this))}getMicrophoneStats(){return E(R,this)?E(R,this):E(y,this).getStats(E(O,this))}getInputStats(){return E(W,this)?E(W,this):E(y,this).getStats()}getRTCInterfaces(){return{rtcPeerConnection:E(y,this),rtcDataChannel:E(M,this),rtcClientMessageChannel:E(I,this)}}async enableAudioInputStream(e){C(G,this,await navigator.mediaDevices.getUserMedia({audio:null==e||e})),E(G,this).getTracks().forEach((e=>{E(y,this).addTrack(e,E(G,this)),C(O,this,e)}))}async generateOffer(e){if(E(y,this)&&!E(k,this)){C(k,this,!0);try{return await this.internalGenerateOffer(e)}catch(e){try{E(y,this).addTransceiver("audio",{direction:"recvonly"}),E(y,this).addTransceiver("video",{direction:"recvonly"})}catch(t){throw s("addTransceiver attempt failed: "+String(t)),e}}}return await this.internalGenerateOffer(e)}async internalGenerateOffer(e){const t=E(y,this),i=await t.createOffer({offerToReceiveAudio:e,offerToReceiveVideo:!0});if(!i.sdp)throw new Error("Browser does not support initiating WebRTC connections");if(i.sdp=v(i.sdp,E(b,this),!1),E(A,this)){const e=new Promise((e=>{t.onicegatheringstatechange=()=>{"complete"==t.iceGatheringState&&e()},setTimeout(e,15e3)}));if(await t.setLocalDescription(i),await e,!t.localDescription)throw new Error("Browser failed to initiate local WebRTC connection");i.sdp=v(t.localDescription.sdp,E(b,this),!0)}else await t.setLocalDescription(i),i.sdp=v(i.sdp,E(b,this),!0);return i}setIceServers(e){E(y,this).setConfiguration({iceServers:e}),C(A,this,e.length>0)}async setRemoteDescription(e){return e.sdp&&E(b,this)&&(e={type:e.type,sdp:m(e.sdp,E(b,this))}),await E(y,this).setRemoteDescription(e)}close(){E(_,this)||C(_,this,this.getVideoStats()),E(T,this)||C(T,this,this.getAudioStats()),E(R,this)||C(R,this,this.getMicrophoneStats()),E(W,this)||C(W,this,this.getInputStats()),E(I,this)&&(E(I,this).close(),C(I,this,void 0),s("Client message channel closed")),E(M,this)&&(E(M,this).close(),C(M,this,void 0),s("Input data channel closed")),E(y,this)&&(E(y,this).close(),C(y,this,void 0),s("RTCPeerConnection closed")),E(G,this)&&(E(G,this).getTracks().forEach((e=>e.stop())),C(G,this,void 0),C(O,this,void 0),s("Stopped microphone media track"))}isClosed(){return null==E(y,this)}}function L(){s(`Ice connection state: ${E(y,this).iceConnectionState}`)}function j(){const e=E(y,this);e.addEventListener("connectionstatechange",(()=>{switch(this.clientConnection.connectionState(e.connectionState),e.connectionState){case"connected":s("The peer is fully connected!");break;case"disconnected":case"failed":s("One or more transports has terminated unexpectedly or in an error!");break;case"closed":s("Connection has been closed")}}))}function P(){E(y,this).onicecandidateerror=e=>{e.errorCode>=300&&e.errorCode<=699?s(`ICE candidate error due to STUN error. code: ${e.errorCode} (reference RFC 5389)`):e.errorCode>=700&&e.errorCode<=799&&s(`ICE candidate error due to server error. code: ${e.errorCode} (reference RFC 5389)`)}}function x(e,t,i){V(e,t),t.set(e,i)}function V(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function B(e,t){return e.get(U(e,t))}function z(e,t,i){return e.set(U(e,t),i),i}function U(e,t,i){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:i;throw new TypeError("Private element is not present on this object")}var F=new WeakMap,K=new WeakMap,J=new WeakMap,Z=new WeakMap,q=new WeakMap,Q=new WeakMap,X=new WeakMap,Y=new WeakMap,ee=new WeakMap,te=new WeakMap,ie=new WeakMap,ne=new WeakMap,oe=new WeakMap,se=new WeakMap,re=new WeakMap,ae=new WeakSet;class ce{constructor(e){var t,i,n,o,s,r,a,c,h,d,l,u,p,f;if(V(this,f=ae),f.add(this),x(this,F,void 0),x(this,K,void 0),x(this,J,void 0),x(this,Z,void 0),x(this,q,void 0),x(this,Q,void 0),x(this,X,void 0),x(this,Y,void 0),x(this,ee,void 0),x(this,te,void 0),x(this,ie,void 0),x(this,ne,void 0),x(this,oe,void 0),x(this,se,void 0),x(this,re,void 0),!e||"object"!=typeof e){if(!("videoElement"in e))throw new Error("Amazon GameLift Streams constructor argument must be an object with a videoElement property");if(!("audioElement"in e))throw new Error("Amazon GameLift Streams constructor argument must be an object with an audioElement property")}if("VIDEO"!==(null===(t=e.videoElement)||void 0===t?void 0:t.tagName))throw new Error("videoElement property must be a HTML <video> element");if("AUDIO"!==(null===(i=e.audioElement)||void 0===i?void 0:i.tagName))throw new Error("audioElement property must be a HTML <audio> element");z(F,this,function(){const e=new Uint8Array(16);return crypto.getRandomValues(e),[...e].map((function(e){return(e+256).toString(16).slice(-2)})).join("")}()),z(K,this,e.videoElement),z(J,this,e.audioElement),z(Z,this,he.call(ce,e.inputConfiguration)),z(Q,this,{connectionState:(null===(n=e.clientConnection)||void 0===n?void 0:n.connectionState)||(e=>{}),channelError:(null===(o=e.clientConnection)||void 0===o?void 0:o.channelError)||(e=>{}),serverDisconnect:(null===(s=e.clientConnection)||void 0===s?void 0:s.serverDisconnect)||(e=>{}),applicationMessage:(null===(r=e.clientConnection)||void 0===r?void 0:r.applicationMessage)||(e=>{}),performanceStats:(null===(a=e.clientConnection)||void 0===a?void 0:a.performanceStats)||(e=>{})}),z(Y,this,null),z(ee,this,!1),z(te,this,!1),z(ie,this,!1),z(ne,this,(null===(c=e.streamConfiguration)||void 0===c?void 0:c.maximumKbps)||0),z(oe,this,null===(h=e.streamConfiguration)||void 0===h?void 0:h.maximumResolution),z(se,this,null===(d=null===(l=e.streamConfiguration)||void 0===l?void 0:l.enableAudio)||void 0===d||d),z(X,this,null===(u=e.streamConfiguration)||void 0===u?void 0:u.iceServers),z(re,this,null===(p=e.streamConfiguration)||void 0===p?void 0:p.forceVideoCodec),z(q,this,new H({videoElement:B(K,this),audioElement:B(J,this),clientConnection:B(Q,this),forcedCodec:B(re,this)}))}get id(){return B(F,this)}async enableMicrophone(e){U(ae,this,le).call(this),await B(q,this).enableAudioInputStream(e)}async generateSignalRequest(){U(ae,this,le).call(this),B(q,this).isClosed()&&(z(te,this,!1),z(q,this,new H({videoElement:B(K,this),audioElement:B(J,this),clientConnection:B(Q,this),forcedCodec:B(re,this)}))),B(q,this).setIceServers(await async function(e){const t=e=>{const t=[];for(const i of e||[])"urls"in i?t.push(i):t.push({urls:i.url,username:i.username,credential:i.credential});return t};if(void 0===e)return[];if(Array.isArray(e))return t(e);const i=e();return Array.isArray(i)?t(i):t(await i)}(B(X,this)));const e=await B(q,this).generateOffer(B(se,this));return JSON.stringify({type:e.type,sdp:e.sdp,webSdkVersion:i,extras:{features:[{name:"WEBRTC_SPLIT_MEDIA_STREAMS",value:"enabled"}]}})}async processSignalResponse(e){let t;U(ae,this,le).call(this);try{t=JSON.parse(e)}catch{t=null}if(!("object"==typeof t&&t&&"sdp"in t&&"string"==typeof t.sdp&&"type"in t&&"answer"===t.type&&"webSdkProtocolUrl"in t&&"string"==typeof t.webSdkProtocolUrl))throw new Error("signalResponse JSON could not be parsed or is missing required properties");await U(ae,this,de).call(this,t.webSdkProtocolUrl,e),await B(q,this).setRemoteDescription({sdp:t.sdp,type:"answer"}),z(ee,this,!0),B(ie,this)&&this.attachInput()}attachInput(){U(ae,this,ue).call(this),B(Y,this).attach(),z(ie,this,!0)}detachInput(){U(ae,this,ue).call(this),B(Y,this).detach(),z(ie,this,!1)}getVideoRTCStats(){return B(q,this).getVideoStats()}getAudioRTCStats(){return B(q,this).getAudioStats()}getMicrophoneRTCStats(){return B(q,this).getMicrophoneStats()}getInputRTCStats(){return B(q,this).getInputStats()}close(){B(Y,this)&&(B(Y,this).detach(),z(Y,this,null)),B(q,this).close(),z(ee,this,!1),z(te,this,!0),z(ie,this,!1)}processKeyboardEvent(e){return!!B(Y,this)&&!!B(Y,this).processKeyboardEvent(e)}processMouseEvent(e){return!!B(Y,this)&&!!B(Y,this).processMouseEvent(e)}addGamepad(e){return!!B(Y,this)&&!!B(Y,this).processGamepadEvent(pe("gamepadconnected",{gamepad:e}))}removeGamepad(e){return!!B(Y,this)&&!!B(Y,this).processGamepadEvent(pe("gamepaddisconnected",{gamepad:e}))}processGamepads(){return!!B(Y,this)&&!!B(Y,this).pollTrackedGamepads()}sendApplicationMessage(e){return!!B(Y,this)&&!!B(Y,this).sendApplicationMessage(e)}}function he(e){var t;const i={setCursor:"visibility",autoPointerLock:"fullscreen",resetOnDetach:!0,trackWindowFocus:!0};for(const[t,n]of Object.entries(null!=e?e:{}))void 0!==n&&(i[t]=n);const n=(null===(t=window)||void 0===t||null===(t=t.navigator)||void 0===t?void 0:t.userAgent)||"unknown",o=n.includes(" Chrome/"),s=n.includes(" Gecko/");return n.includes(" Safari/")&&!o&&!s&&(i.autoPointerLock=!1),i}async function de(e,t){if(B(Y,this))return;s("Initialize input module"),await async function(e){return new Promise(((t,i)=>{const n=document.createElement("script");n.setAttribute("src",e),n.setAttribute("crossorigin","anonymous"),n.addEventListener("load",(()=>{s("Successfully loaded "+e),t(!0)})),n.addEventListener("error",(()=>{s("Failed to load "+e),i(new Error("Error when loading script "+e))})),document.body.appendChild(n)}))}(e);let n=null;if("GameCastInputModule"in window&&"object"==typeof window.GameCastInputModule&&window.GameCastInputModule&&"GameCastInput"in window.GameCastInputModule&&"function"==typeof window.GameCastInputModule.GameCastInput&&(n=window.GameCastInputModule.GameCastInput),!n)throw new Error("input module not available, dynamic protocol file failed to load");const o={webSdkVersion:i,signalResponse:t,videoElement:B(K,this),inputConfiguration:B(Z,this),clientRtc:B(q,this).getRTCInterfaces(),debugLog:s,onServerDisconnect:e=>B(Q,this).serverDisconnect(e),onApplicationMessageReceived:B(Q,this).applicationMessage,onPerformanceStatsReceived:B(Q,this).performanceStats,bitrateMaxKilobits:B(ne,this),maximumResolution:B(oe,this)};z(Y,this,new n(o))}function le(){if(B(ee,this))throw new Error("This instance is already bound to a stream, call close() and create a new instance")}function ue(){if(!B(ee,this)||B(te,this))throw new Error("This instance is not currently streaming")}function pe(e,t){const i=new Event(e,t);return i.gamepad=t.gamepad,i}const fe=i;var me=t.Zb,ve=t.xv,we=t.He;export{me as GameLiftStreams,ve as VERSION,we as setLogLevel};